services:
  # Backend API
  app:
    build: .
    # Ports not exposed to host, only internal network for Nginx
    # ports:
    #   - "8000:8000"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-storageinator}
      # Update these for production S3
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_PUBLIC_URL=${S3_PUBLIC_URL}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-storageinator}
      - S3_REGION=${S3_REGION:-us-east-1}
      # Security
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost,https://yourdomain.com}
      - ALLOWED_MIME_TYPES=${ALLOWED_MIME_TYPES:-image/jpeg,image/png,image/gif,application/pdf,text/plain,application/zip,application/octet-stream,video/mp4,video/webm,video/ogg}
      # Admin
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
    depends_on:
      - mongodb
    restart: always

  # Frontend (Nginx)
  frontend:
    build: ./frontend
    ports:
      - "80:80"
      # - "443:443" # Uncomment if configuring SSL in nginx.conf
    depends_on:
      - app
    restart: always

  # MongoDB Database
  mongodb:
    image: mongo:7
    # Ports not exposed to host for security
    # ports:
    #   - "27017:27017" 
    volumes:
      - mongodb_data:/data/db
    restart: always

volumes:
  mongodb_data:
